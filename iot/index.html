<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="text-gray-900 font-sans flex justify-center items-center h-screen bg-gray-100">
    <div id="app" class="question-card bg-white p-6 rounded-lg shadow-lg w-[800px]">
        <div v-if="!sectionSelected" class="text-center">
            <img src="https://nic.tut.edu.tw/var/file/12/1012/pictures/684/m/mczh-tw400x400_small14858_202087529952.png" alt="TQC 物聯網智慧應用及技術 第2版-專業級" class="mb-4 mx-auto w-3/4">
            <p class="text-xl font-bold mb-4">請選擇要開始的部分</p>
            <p class="mb-4">每部分包含 60 題，共 360 題</p>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <button v-for="section in 6" :key="section" @click="changeSection(section)"
                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                    第 {{ section }} 部分
                </button>
            </div>
            <button @click="downloadJson" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">下載題庫 JSON
                檔(360題)</button>
            <div class="mt-6">
                <input v-model="searchQuery" type="text" placeholder="輸入 5 個字以上的關鍵字" class="px-4 py-2 border rounded w-2/3">
                <p v-if="searchQuery.length > 0 && searchQuery.length < 5" class="text-red-500 text-sm mt-1">請輸入至少 5 個字</p>
                <button @click="searchQuestion" class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 ml-2" :disabled="searchQuery.length < 5">搜尋題目</button>

            </div>
            <div v-if="searchResults.length" class="mt-4 p-4 border rounded bg-gray-200 text-left">
                <p class="font-bold">搜尋結果：</p>
                <div v-for="result in searchResults" :key="result.question_number" class="mb-4 p-2 border-b">
                    <p class="font-bold">題目：{{ result.question }}</p>
                    <ul>
                        <li v-for="(option, key) in result.options" :key="key">{{ key }}: {{ option }}</li>
                    </ul>
                    <p class="font-bold text-green-600">正確答案: {{ result.correct_answer.join(', ') }}</p>
                </div>
            </div>

        </div>
        <div v-else>
            <div class="text-center text-lg font-bold mb-4">目前進行第 {{ currentQuestionIndex + 1 }} 題，共 {{ questions.length
                }} 題</div>
            <div v-if="currentQuestion">
                <div class="text-lg font-bold mb-4">第 {{ currentQuestion.question_number }} 題</div>
                <div class="text-xl font-bold mb-4">{{ currentQuestion.question }}</div>
                <form @submit.prevent="submitAnswer">
                    <div class="text-lg font-bold">
                        <label v-for="(option, key) in currentQuestion.options" :key="key" class="block mb-2">
                            <input type="checkbox" :value="key" v-model="selectedOptions" class="mr-2"> {{ key }}: {{
                            option }}
                        </label>
                    </div>
                    <div class="mt-4 flex justify-between">
                        <button type="button" @click="goBack"
                            class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">上一題</button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">下一題</button>
                        <button type="button" @click="jumpToResult"
                            class="px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">直接交卷</button>
                    </div>
                </form>
            </div>
            <div v-else class="text-center">
                <p class="text-green-600 font-bold">測驗結束!</p>
                <p class="font-bold">你的答對率: {{ score }}/{{ questions.length }} 題</p>
                <button @click="restartExam"
                    class="mt-4 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">重新開始測驗</button>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3"></script>
    <script>
        const { createApp, ref, onMounted } = Vue;

        createApp({
            setup() {
                const questions = ref([]);
                const currentQuestionIndex = ref(0);
                const currentQuestion = ref(null);
                const selectedOptions = ref([]);
                const showResult = ref(false);
                const isCorrect = ref(false);
                const score = ref(0);
                const sectionSize = 60;
                const currentSection = ref(1);
                const sectionSelected = ref(false);
                const searchQuery = ref("");
                const searchResult = ref(null);
                const searchResults = ref([]);

                async function loadQuestions() {
                    const response = await fetch('questions.json');
                    const allQuestions = await response.json();
                    questions.value = allQuestions.slice((currentSection.value - 1) * sectionSize, currentSection.value * sectionSize);
                    currentQuestion.value = questions.value[currentQuestionIndex.value];
                }

                function changeSection(section) {
                    currentSection.value = section;
                    currentQuestionIndex.value = 0;
                    sectionSelected.value = true;
                    loadQuestions();
                }

                function submitAnswer() {
                    showResult.value = true;
                    const correctOptions = currentQuestion.value.correct_answer;
                    isCorrect.value = correctOptions.every(opt => selectedOptions.value.includes(opt)) &&
                        selectedOptions.value.every(opt => correctOptions.includes(opt));
                    if (isCorrect.value) {
                        score.value++;
                    }
                    setTimeout(() => {
                        nextQuestion();
                        selectedOptions.value = [];
                    }, 1000);
                }

                function nextQuestion() {
                    if (currentQuestionIndex.value < questions.value.length - 1) {
                        currentQuestionIndex.value++;
                        currentQuestion.value = questions.value[currentQuestionIndex.value];
                        showResult.value = false;
                    } else {
                        currentQuestion.value = null;
                    }
                }

                function goBack() {
                    if (currentQuestionIndex.value > 0) {
                        currentQuestionIndex.value--;
                        currentQuestion.value = questions.value[currentQuestionIndex.value];
                        showResult.value = false;
                    }
                }

                function jumpToResult() {
                    currentQuestion.value = null;
                }

                function restartExam() {
                    score.value = 0;
                    currentQuestionIndex.value = 0;
                    sectionSelected.value = false;
                }

                function searchQuestion() {
                    if (searchQuery.value.length < 5) return;
                    fetch('questions.json')
                        .then(response => response.json())
                        .then(allQuestions => {
                            searchResults.value = allQuestions.filter(q => q.question.includes(searchQuery.value));
                        });
                }



                function downloadJson() {
                    const link = document.createElement('a');
                    link.href = 'questions.json';
                    link.download = 'questions.json';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }

                onMounted(loadQuestions);

                return {
                    questions,
                    currentQuestion,
                    selectedOptions,
                    submitAnswer,
                    goBack,
                    jumpToResult,
                    score,
                    showResult,
                    isCorrect,
                    restartExam,
                    currentQuestionIndex,
                    changeSection,
                    sectionSelected,
                    searchQuery,
                    searchQuestion,
                    searchResult,
                    searchResults,
                    downloadJson,
                    nextQuestion
                };
            }
        }).mount("#app");

    </script>
</body>

</html>